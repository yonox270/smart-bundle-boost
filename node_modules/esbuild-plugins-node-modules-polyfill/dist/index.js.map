{"version":3,"sources":["../src/lib/utils/util.ts","../src/lib/polyfill.ts","../src/lib/plugin.ts"],"names":["path","builtinModules","resolve","loadPackageJSON","resolveExports","resolveModule","join","build","process","polyfillPath"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;AAAO,IAAM,WAAA,mBAAc,MAAA,CAAA,CAAC,GAAA,KAAgB,GAAA,CAAI,OAAA,CAAQ,qBAAA,EAAuB,MAAM,CAAA,CAAE,OAAA,CAAQ,IAAA,EAAM,OAAO,CAAA,EAAjF,aAAA;AAEpB,IAAM,mCAAmB,MAAA,CAAA,CAAC,EAAE,YAAW,KAA8B,CAAA,eAAA,EAAkB,UAAU,CAAA,CAAA,CAAA,EAAxE,kBAAA;AAEzB,IAAM,wBAAA,mBAA2B,MAAA,CAAA,CAACA,KAAAA,KAAiBA,KAAAA,CAAK,OAAA,CAAQ,QAAA,EAAU,EAAE,CAAA,CAAE,OAAA,CAAQ,KAAA,EAAO,EAAE,CAAA,EAA9D,0BAAA;ACKxC,eAAe,aAAa,UAAA,EAAoB;AAC/C,EAAA,IAAI,CAACC,uBAAA,CAAe,QAAA,CAAS,UAAU,CAAA;AACtC,IAAA,MAAM,IAAI,KAAA,CAAM,CAAA,sBAAA,EAAyB,UAAU,CAAA,uBAAA,CAAyB,CAAA;AAE7E,EAAA,MAAM,QAAA,GAAWC,YAAA;AAAA,IAChB,SAAA,CAAQ,OAAA,CAAQ,CAAA,oBAAA,EAAuB,UAAU,CAAA,CAAE,CAAA;AAAA;AAAA,IAEnD,UAAA,IAAc,UAAA,CAAW,QAAA,CAAS,GAAG,IAAI,KAAA,GAAQ,EAAA;AAAA,GAClD;AAEA,EAAA,MAAM,eAAA,GAAkB,MAAMC,wBAAA,CAAgB,QAAQ,CAAA;AACtD,EAAA,MAAM,UAAA,GAAaC,uBAAA,CAAe,eAAA,EAAiB,CAAA,WAAA,EAAc,UAAU,CAAA,CAAA,EAAI;AAAA,IAC9E,OAAA,EAAS;AAAA,GACT,CAAA;AAED,EAAA,MAAM,cAAA,GAAiBC,uBAAcC,SAAA,CAAK,QAAA,EAAU,aAAa,CAAC,CAAA,IAAK,EAAE,CAAC,CAAA;AAE1E,EAAA,IAAI,CAAC,UAAA,IAAc,CAAC,cAAA,EAAgB;AACnC,IAAA,MAAM,IAAI,KAAA;AAAA,MACT;AAAA,KACD;AAAA,EACD;AACA,EAAA,OAAO,cAAA;AACR;AAvBe,MAAA,CAAA,YAAA,EAAA,cAAA,CAAA;AAyBf,IAAM,iBAAA,uBAAsD,GAAA,EAAI;AAChE,IAAM,iBAAA,uBAA6C,GAAA,EAAI;AAEhD,IAAM,oBAAA,2BAAwB,SAAA,KAAsC;AAC1E,EAAA,iBAAA,CAAkB,KAAA,EAAM;AACxB,EAAA,KAAA,MAAW,CAAC,UAAA,EAAY,UAAU,KAAK,MAAA,CAAO,OAAA,CAAQ,SAAS,CAAA,EAAG;AACjE,IAAA,MAAM,oBAAA,GAAuB,yBAAyB,UAAU,CAAA;AAChE,IAAA,iBAAA,CAAkB,GAAA,CAAI,sBAAsB,UAAU,CAAA;AAAA,EACvD;AACD,CAAA,EANoC,sBAAA,CAAA;AAQ7B,IAAM,qBAAA,2BAAyB,UAAA,KAAwC;AAC7E,EAAA,MAAM,oBAAA,GAAuB,yBAAyB,UAAU,CAAA;AAGhE,EAAA,MAAM,QAAA,GAAW,iBAAA,CAAkB,GAAA,CAAI,oBAAoB,CAAA;AAC3D,EAAA,IAAI,QAAA,EAAU,OAAO,OAAA,CAAQ,OAAA,CAAQ,QAAQ,CAAA;AAE7C,EAAA,MAAM,aAAA,GAAgB,iBAAA,CAAkB,GAAA,CAAI,oBAAoB,CAAA;AAChE,EAAA,IAAI,eAAe,OAAO,aAAA;AAE1B,EAAA,MAAM,OAAA,GAAU,aAAa,oBAAoB,CAAA;AACjD,EAAA,iBAAA,CAAkB,GAAA,CAAI,sBAAsB,OAAO,CAAA;AACnD,EAAA,OAAO,OAAA;AACR,CAAA,EAbqC,uBAAA,CAAA;AAe9B,IAAM,2BAAA,iCAAqC,UAAA,KAAuB;AACxE,EAAA,MAAM,cAAA,GAAiB,MAAM,qBAAA,CAAsB,UAAU,CAAA;AAE7D,EAAA,MAAM,OAAA,GAAA,CACL,MAAMC,aAAA,CAAM;AAAA,IACX,KAAA,EAAO,KAAA;AAAA,IACP,MAAA,EAAQ,KAAA;AAAA,IACR,MAAA,EAAQ,IAAA;AAAA,IACR,WAAA,EAAa,CAAC,cAAc;AAAA,GAC5B,CAAA,EACA,WAAA,CAAY,CAAC,CAAA,CAAE,IAAA;AAEjB,EAAA,OAAO,OAAA,CAAQ,OAAA,CAAQ,SAAA,EAAW,WAAW,CAAA;AAC9C,CAAA,EAb2C,6BAAA,CAAA;AAe3C,IAAM,oBAAA,uBAAyD,GAAA,EAAI;AAC5D,IAAM,wBAAA,2BAA4B,UAAA,KAAwC;AAChF,EAAA,MAAM,oBAAA,GAAuB,yBAAyB,UAAU,CAAA;AAEhE,EAAA,MAAM,aAAA,GAAgB,oBAAA,CAAqB,GAAA,CAAI,oBAAoB,CAAA;AACnE,EAAA,IAAI,eAAe,OAAO,aAAA;AAE1B,EAAA,MAAM,OAAA,GAAU,4BAA4B,oBAAoB,CAAA;AAChE,EAAA,oBAAA,CAAqB,GAAA,CAAI,sBAAsB,OAAO,CAAA;AACtD,EAAA,OAAO,OAAA;AACR,CAAA,EATwC,0BAAA,CAAA;;;AChExC,IAAM,IAAA,GAAO,wBAAA;AAeb,IAAM,MAAA,iCAAgB,IAAA,KAA4D;AACjF,EAAA,IAAI;AACH,IAAA,MAAM,UAAA,GAAa,IAAA,CAAK,SAAA,CAAU,QAAA,CAAS,UAAU,CAAA;AAErD,IAAA,MAAM,QAAA,GAAW,MAAM,qBAAA,CAAsB,IAAA,CAAK,IAAI,CAAA;AACtD,IAAA,MAAM,UAAA,GAAaP,qBAAA,CAAK,OAAA,CAAQ,QAAQ,CAAA;AAExC,IAAA,IAAI,UAAA,EAAY,OAAO,EAAE,MAAA,EAAQ,IAAA,EAAM,QAAA,EAAU,gBAAA,CAAiB,EAAE,UAAA,EAAY,IAAA,CAAK,IAAA,EAAM,GAAG,UAAA,EAAW;AAEzG,IAAA,MAAM,QAAA,GAAW,MAAM,wBAAA,CAAyB,IAAA,CAAK,IAAI,CAAA;AAEzD,IAAA,OAAO,EAAE,MAAA,EAAQ,IAAA,EAAM,QAAA,EAAU,UAAA,EAAW;AAAA,EAC7C,SAAS,KAAA,EAAO;AACf,IAAA,OAAA,CAAQ,KAAA,CAAM,yBAAyB,KAAK,CAAA;AAC5C,IAAA,OAAO,EAAE,QAAA,EAAU,CAAA,SAAA,CAAA,EAAa,MAAA,EAAQ,IAAA,EAAK;AAAA,EAC9C;AACD,CAAA,EAhBe,QAAA,CAAA;AAkBR,IAAM,yBAAA,mBAA4B,MAAA,CAAA,CAAC,OAAA,GAAgC,EAAC,KAAc;AACxF,EAAA,MAAM;AAAA,IACL,UAAU,EAAC;AAAA,IACX,SAAS,aAAA,GAAgBC,uBAAAA;AAAA,IACzB,QAAA,GAAW,MAAA;AAAA,IACX,WAAA;AAAA,IACA,SAAA,GAAY,IAAA;AAAA,IACZ,IAAA,GAAO,IAAA;AAAA,IACP,YAAY;AAAC,GACd,GAAI,OAAA;AACJ,EAAA,IAAI,SAAA,CAAU,SAAS,UAAU,CAAA,QAAS,IAAI,KAAA,CAAM,CAAA,UAAA,EAAa,SAAS,CAAA,2BAAA,CAA6B,CAAA;AAEvG,EAAA,IAAI,SAAA,CAAU,SAAS,OAAO,CAAA,QAAS,IAAI,KAAA,CAAM,CAAA,UAAA,EAAa,SAAS,CAAA,wBAAA,CAA0B,CAAA;AAEjG,EAAA,IAAI,SAAA,CAAU,SAAS,OAAO,CAAA,QAAS,IAAI,KAAA,CAAM,CAAA,UAAA,EAAa,SAAS,CAAA,wBAAA,CAA0B,CAAA;AAGjG,EAAA,IAAI,OAAO,IAAA,CAAK,SAAS,EAAE,MAAA,GAAS,CAAA,uBAAwB,SAAS,CAAA;AAErE,EAAA,MAAM,UAAU,KAAA,CAAM,OAAA,CAAQ,aAAa,CAAA,GACxC,OAAO,WAAA,CAAa,aAAA,CAA2B,GAAA,CAAI,CAAC,QAAQ,CAAC,GAAA,EAAK,IAAI,CAAC,CAAC,CAAA,GACvE,aAAA;AAEJ,EAAA,MAAM,iBAAA,GAAoB,GAAG,SAAS,CAAA,SAAA,CAAA;AACtC,EAAA,MAAM,cAAA,GAAiB,GAAG,SAAS,CAAA,MAAA,CAAA;AACnC,EAAA,MAAM,cAAA,GAAiB,GAAG,SAAS,CAAA,MAAA,CAAA;AAEnC,EAAA,MAAM,wBAAA,GAA2B,aAAa,OAAA,IAAW,MAAA,CAAO,OAAO,OAAO,CAAA,CAAE,SAAS,OAAO,CAAA;AAEhG,EAAA,OAAO;AAAA,IACN,IAAA;AAAA,IACA,uBAAO,MAAA,CAAA,CAAC,EAAE,QAAQ,SAAA,EAAW,KAAA,EAAO,gBAAe,KAAM;AACxD,MAAA,IAAI,wBAAA,IAA4B,eAAe,KAAA,KAAU,KAAA;AACxD,QAAA,MAAM,IAAI,MAAM,CAAA,kFAAA,CAAoF,CAAA;AAErG,MAAA,MAAM,IAAA,GAAO,cAAA,CAAe,aAAA,IAAiBO,wBAAA,CAAQ,GAAA,EAAI;AAGzD,MAAA,IAAI,cAAA,CAAe,UAAU,CAAC,cAAA,CAAe,OAAO,MAAA,EAAQ,cAAA,CAAe,OAAO,MAAA,GAAS,YAAA;AAAA,WAAA,IAClF,CAAC,cAAA,CAAe,MAAA,iBAAuB,MAAA,GAAS,EAAE,QAAQ,YAAA,EAAa;AAEhF,MAAA,cAAA,CAAe,MAAA,GAAS,cAAA,CAAe,MAAA,IAAU,EAAC;AAElD,MAAA,IAAI,OAAA,CAAQ,QAAQ,cAAA,CAAe,MAAA,CAAO,KAAKR,qBAAA,CAAK,OAAA,CAAQ,SAAA,EAAW,sBAAsB,CAAC,CAAA;AAE9F,MAAA,IAAI,OAAA,CAAQ,SAAS,cAAA,CAAe,MAAA,CAAO,KAAKA,qBAAA,CAAK,OAAA,CAAQ,SAAA,EAAW,uBAAuB,CAAC,CAAA;AAEhG,MAAA,MAAA,CAAO,EAAE,MAAA,EAAQ,IAAA,EAAM,SAAA,EAAW,cAAA,IAAkB,OAAO;AAAA,QAC1D,MAAA,EAAQ,IAAA;AAAA;AAAA;AAAA;AAAA,QAIR,QAAA,EAAU;AAAA,OACX,CAAE,CAAA;AAEF,MAAA,MAAA,CAAO,EAAE,MAAA,EAAQ,IAAA,EAAM,WAAW,cAAA,EAAe,EAAG,CAAC,IAAA,MAAU;AAAA,QAC9D,MAAA,EAAQ,IAAA;AAAA,QACR,QAAA,EAAU,oBAAoB,IAAA,CAAK,SAAA;AAAA;AAAA,UAElC,qCAAqC,IAAA,CAAK,IAAI,CAAA,YAAA,EAAe,IAAA,CAAK,WAAW,QAAQ,CAAA,wBAAA;AAAA,SACrF,CAAA;AAAA,OACF,CAAE,CAAA;AAEF,MAAA,MAAA,CAAO,EAAE,MAAA,EAAQ,IAAA,EAAM,SAAA,IAAa,MAAM,CAAA;AAC1C,MAAA,MAAA,CAAO,EAAE,MAAA,EAAQ,IAAA,EAAM,SAAA,EAAW,iBAAA,IAAqB,MAAM,CAAA;AAI7D,MAAA,MAAM,cAAA,GACL,QAAA,KAAa,MAAA,GACV,MAAA,CAAO,KAAK,OAAO,CAAA,CAAE,MAAA,CAAO,CAAC,UAAA,KAAeC,uBAAAA,CAAe,QAAA,CAAS,UAAU,CAAC,CAAA,GAC/EA,uBAAAA;AAEJ,MAAA,MAAM,MAAA,GAAS,IAAI,MAAA,CAAO,CAAA,cAAA,EAAiB,cAAA,CAAe,GAAA,CAAI,WAAW,CAAA,CAAE,IAAA,CAAK,GAAG,CAAC,CAAA,EAAA,CAAI,CAAA;AAExF,MAAA,MAAM,QAAA,iCAAkB,IAAA,KAA8D;AACrF,QAAA,MAAM,MAAA,GAAS;AAAA,UACd,KAAA,EAAO,EAAE,SAAA,EAAW,cAAA,EAAgB,MAAM,IAAA,CAAK,IAAA,EAAM,aAAa,KAAA,EAAM;AAAA,UACxE,KAAA,EAAO;AAAA,YACN,SAAA,EAAW,cAAA;AAAA,YACX,MAAM,IAAA,CAAK,IAAA;AAAA,YACX,WAAA,EAAa,KAAA;AAAA,YACb,UAAA,EAAY,EAAE,QAAA,EAAUD,qBAAA,CAAK,QAAA,CAAS,IAAA,EAAM,IAAA,CAAK,QAAQ,CAAA,CAAE,OAAA,CAAQ,KAAA,EAAO,GAAG,CAAA;AAAE,WAChF;AAAA,UACA,IAAA,EAAM;AAAA,SACP;AAGA,QAAA,IAAI,cAAA,CAAe,aAAa,SAAA,EAAW;AAC1C,UAAA,MAAM,WAAA,GAAc,MAAMG,wBAAAA,CAAgB,IAAA,CAAK,UAAU,CAAA;AACzD,UAAA,MAAM,oBAAoB,WAAA,EAAa,OAAA;AAKvC,UAAA,IAAI,OAAO,sBAAsB,QAAA,EAAU;AAC3C,UAAA,MAAM,0BAAA,GAA6B,iBAAA,GAAoB,IAAA,CAAK,IAAI,CAAA;AAQhE,UAAA,IAAI,0BAAA,KAA+B,KAAA,EAAO,OAAO,MAAA,CAAO,KAAA;AAExD,UAAA,IAAI,+BAA+B,MAAA,EAAW;AAAA,QAC/C;AAEA,QAAA,MAAM,UAAA,GAAa,wBAAA,CAAyB,IAAA,CAAK,IAAI,CAAA;AAErD,QAAA,MAAM,iBAAiB,OAAA,CAAQ,UAAU,KAAK,OAAA,CAAQ,CAAA,KAAA,EAAQ,UAAU,CAAA,CAAE,CAAA;AAE1E,QAAA,IAAI,CAAC,cAAA,EAAgB,OAAO,MAAA,CAAO,QAAQ,CAAA;AAE3C,QAAA,IAAI,mBAAmB,OAAA,IAAW,cAAA,KAAmB,OAAA,EAAS,OAAO,OAAO,cAAc,CAAA;AAE1F,QAAA,MAAMM,gBAAe,MAAM,qBAAA,CAAsB,UAAU,CAAA,CAAE,KAAA,CAAM,MAAM,IAAI,CAAA;AAE7E,QAAA,IAAI,CAACA,aAAAA,EAAc,OAAO,MAAA,CAAO,QAAQ,CAAA;AAEzC,QAAA,MAAM,aAAA,GAAgB,KAAK,SAAA,KAAc,iBAAA;AACzC,QAAA,MAAM,UAAA,GAAa,CAAC,aAAA,IAAiB,IAAA,CAAK,IAAA,KAAS,cAAA;AAEnD,QAAA,OAAO,EAAE,WAAW,UAAA,GAAa,iBAAA,GAAoB,WAAW,IAAA,EAAM,IAAA,CAAK,IAAA,EAAM,WAAA,EAAa,KAAA,EAAM;AAAA,MACrG,CAAA,EAlDiB,UAAA,CAAA;AAoDjB,MAAA,SAAA,CAAU,EAAE,MAAA,EAAO,EAAG,QAAQ,CAAA;AAE9B,MAAA,KAAA,CAAM,OAAO,EAAE,WAAA,GAAc,IAAG,KAAM;AAYrC,QAAA,IAAI,CAAC,wBAAA,EAA0B;AAE/B,QAAA,MAAM,SAA2B,EAAC;AAElC,QAAA,MAAM,EAAE,OAAA,EAAS,YAAA,GAAe,IAAG,GAAI,cAAA;AACvC,QAAA,MAAM,WAAA,GAAc,UAAUT,qBAAA,CAAK,OAAA,CAAQ,OAAO,CAAA,GAAI,YAAA,CAAa,KAAK,CAAA,IAAK,KAAA;AAC7E,QAAA,MAAM,OAAA,GAAU,WAAA,CAAY,MAAA,CAAO,CAAC,IAAA,KAASA,sBAAK,OAAA,CAAQ,IAAA,CAAK,IAAI,CAAA,KAAM,WAAW,CAAA;AAEpF,QAAA,KAAA,MAAW,QAAQ,OAAA,EAAS;AAC3B,UAAA,MAAM,OAAA,GAAU,KAAK,IAAA,CAAK,QAAA;AAAA,YACzB;AAAA,WACD;AAEA,UAAA,KAAA,MAAW,EAAE,MAAA,EAAO,IAAK,OAAA,EAAS;AACjC,YAAA,MAAM,EAAE,UAAA,EAAY,QAAA,EAAS,GAAI,MAAA;AACjC,YAAA,MAAM,cAAA,GAAkB,MAAM,qBAAA,CAAsB,UAAU,EAAE,KAAA,CAAM,MAAM,IAAI,CAAA,KAAO,IAAA;AACvF,YAAA,MAAA,CAAO,IAAA,CAAK;AAAA,cACX,UAAA,EAAY,IAAA;AAAA,cACZ,IAAA,EAAM,cAAA,GACH,CAAA,sCAAA,EAAyC,UAAU,CAAA,gBAAA,EAAmB,QAAQ,CAAA,CAAA,CAAA,GAC9E,CAAA,6BAAA,EAAgC,UAAU,CAAA,gBAAA,EAAmB,QAAQ,CAAA,CAAA,CAAA;AAAA,cACxE,GAAI,WAAA,GAAc,MAAM,WAAA,CAAY,EAAE,YAAY,QAAA,EAAU,cAAA,EAAgB,CAAA,GAAI;AAAC,aACjF,CAAA;AAAA,UACF;AAAA,QACD;AAEA,QAAA,OAAO,EAAE,MAAA,EAAO;AAAA,MACjB,CAAC,CAAA;AAAA,IACF,CAAA,EA1IO,OAAA;AAAA,GA2IR;AACD,CAAA,EA3KyC,2BAAA","file":"index.js","sourcesContent":["export const escapeRegex = (str: string) => str.replace(/[$()*+.?[\\\\\\]^{|}]/g, '\\\\$&').replace(/-/g, '\\\\x2d');\n\nexport const commonJsTemplate = ({ importPath }: { importPath: string }) => `export * from '${importPath}'`;\n\nexport const normalizeNodeBuiltinPath = (path: string) => path.replace(/^node:/, '').replace(/\\/$/, '');\n","import { builtinModules } from 'node:module';\nimport { resolve, join } from 'node:path';\n\nimport { build } from 'esbuild';\nimport { loadPackageJSON, resolveModule } from 'local-pkg';\nimport { resolve as resolveExports } from 'resolve.exports';\n\nimport { normalizeNodeBuiltinPath } from './utils/util.js';\n\nasync function polyfillPath(importPath: string) {\n\tif (!builtinModules.includes(importPath))\n\t\tthrow new Error(`Node.js does not have ${importPath} in its builtin modules`);\n\n\tconst jspmPath = resolve(\n\t\trequire.resolve(`@jspm/core/nodelibs/${importPath}`),\n\t\t// ensure sub path modules are resolved properly\n\t\t'../../..' + (importPath.includes('/') ? '/..' : ''),\n\t);\n\n\tconst jspmPackageJson = await loadPackageJSON(jspmPath);\n\tconst exportPath = resolveExports(jspmPackageJson, `./nodelibs/${importPath}`, {\n\t\tbrowser: true,\n\t});\n\n\tconst exportFullPath = resolveModule(join(jspmPath, exportPath?.[0] ?? ''));\n\n\tif (!exportPath || !exportFullPath) {\n\t\tthrow new Error(\n\t\t\t'resolving failed, please try creating an issue in https://github.com/imranbarbhuiya/esbuild-plugins-node-modules-polyfill',\n\t\t);\n\t}\n\treturn exportFullPath;\n}\n\nconst polyfillPathCache: Map<string, Promise<string>> = new Map();\nconst polyfillOverrides: Map<string, string> = new Map();\n\nexport const setPolyfillOverrides = (overrides: Record<string, string>) => {\n\tpolyfillOverrides.clear();\n\tfor (const [moduleName, customPath] of Object.entries(overrides)) {\n\t\tconst normalizedModuleName = normalizeNodeBuiltinPath(moduleName);\n\t\tpolyfillOverrides.set(normalizedModuleName, customPath);\n\t}\n};\n\nexport const getCachedPolyfillPath = (importPath: string): Promise<string> => {\n\tconst normalizedImportPath = normalizeNodeBuiltinPath(importPath);\n\n\t// Check for custom override first\n\tconst override = polyfillOverrides.get(normalizedImportPath);\n\tif (override) return Promise.resolve(override);\n\n\tconst cachedPromise = polyfillPathCache.get(normalizedImportPath);\n\tif (cachedPromise) return cachedPromise;\n\n\tconst promise = polyfillPath(normalizedImportPath);\n\tpolyfillPathCache.set(normalizedImportPath, promise);\n\treturn promise;\n};\n\nexport const polyfillContentAndTransform = async (importPath: string) => {\n\tconst exportFullPath = await getCachedPolyfillPath(importPath);\n\n\tconst content = (\n\t\tawait build({\n\t\t\twrite: false,\n\t\t\tformat: 'esm',\n\t\t\tbundle: true,\n\t\t\tentryPoints: [exportFullPath],\n\t\t})\n\t).outputFiles[0].text;\n\n\treturn content.replace(/eval\\(/g, '(0,eval)(');\n};\n\nconst polyfillContentCache: Map<string, Promise<string>> = new Map();\nexport const getCachedPolyfillContent = (importPath: string): Promise<string> => {\n\tconst normalizedImportPath = normalizeNodeBuiltinPath(importPath);\n\n\tconst cachedPromise = polyfillContentCache.get(normalizedImportPath);\n\tif (cachedPromise) return cachedPromise;\n\n\tconst promise = polyfillContentAndTransform(normalizedImportPath);\n\tpolyfillContentCache.set(normalizedImportPath, promise);\n\treturn promise;\n};\n","import { builtinModules } from 'node:module';\nimport path from 'node:path';\nimport process from 'node:process';\n\nimport { loadPackageJSON } from 'local-pkg';\n\nimport { getCachedPolyfillContent, getCachedPolyfillPath, setPolyfillOverrides } from './polyfill.js';\nimport { escapeRegex, commonJsTemplate, normalizeNodeBuiltinPath } from './utils/util.js';\n\nimport type { OnResolveArgs, OnResolveResult, PartialMessage, Plugin } from 'esbuild';\nimport type esbuild from 'esbuild';\n\nconst NAME = 'node-modules-polyfills';\n\nexport interface NodePolyfillsOptions {\n\tfallback?: 'empty' | 'error' | 'none';\n\tformatError?: (\n\t\tthis: void,\n\t\targs: { importer: string; moduleName: string; polyfillExists: boolean },\n\t) => PartialMessage | Promise<PartialMessage>;\n\tglobals?: { Buffer?: boolean; process?: boolean };\n\tmodules?: Record<string, boolean | 'empty' | 'error'> | string[];\n\tname?: string;\n\tnamespace?: string;\n\toverrides?: Record<string, string>;\n}\n\nconst loader = async (args: esbuild.OnLoadArgs): Promise<esbuild.OnLoadResult> => {\n\ttry {\n\t\tconst isCommonjs = args.namespace.endsWith('commonjs');\n\n\t\tconst resolved = await getCachedPolyfillPath(args.path);\n\t\tconst resolveDir = path.dirname(resolved);\n\n\t\tif (isCommonjs) return { loader: 'js', contents: commonJsTemplate({ importPath: args.path }), resolveDir };\n\n\t\tconst contents = await getCachedPolyfillContent(args.path);\n\n\t\treturn { loader: 'js', contents, resolveDir };\n\t} catch (error) {\n\t\tconsole.error('node-modules-polyfill', error);\n\t\treturn { contents: `export {}`, loader: 'js' };\n\t}\n};\n\nexport const nodeModulesPolyfillPlugin = (options: NodePolyfillsOptions = {}): Plugin => {\n\tconst {\n\t\tglobals = {},\n\t\tmodules: modulesOption = builtinModules,\n\t\tfallback = 'none',\n\t\tformatError,\n\t\tnamespace = NAME,\n\t\tname = NAME,\n\t\toverrides = {},\n\t} = options;\n\tif (namespace.endsWith('commonjs')) throw new Error(`namespace ${namespace} must not end with commonjs`);\n\n\tif (namespace.endsWith('empty')) throw new Error(`namespace ${namespace} must not end with empty`);\n\n\tif (namespace.endsWith('error')) throw new Error(`namespace ${namespace} must not end with error`);\n\n\t// Set the polyfill overrides\n\tif (Object.keys(overrides).length > 0) setPolyfillOverrides(overrides);\n\n\tconst modules = Array.isArray(modulesOption)\n\t\t? Object.fromEntries((modulesOption as string[]).map((mod) => [mod, true]))\n\t\t: (modulesOption as Record<string, boolean | 'empty' | 'error'>);\n\n\tconst commonjsNamespace = `${namespace}-commonjs`;\n\tconst emptyNamespace = `${namespace}-empty`;\n\tconst errorNamespace = `${namespace}-error`;\n\n\tconst shouldDetectErrorModules = fallback === 'error' || Object.values(modules).includes('error');\n\n\treturn {\n\t\tname,\n\t\tsetup: ({ onLoad, onResolve, onEnd, initialOptions }) => {\n\t\t\tif (shouldDetectErrorModules && initialOptions.write !== false)\n\t\t\t\tthrow new Error(`The \"write\" build option must be set to false when using the \"error\" polyfill type`);\n\n\t\t\tconst root = initialOptions.absWorkingDir ?? process.cwd();\n\n\t\t\t// polyfills contain global keyword, it must be defined\n\t\t\tif (initialOptions.define && !initialOptions.define.global) initialOptions.define.global = 'globalThis';\n\t\t\telse if (!initialOptions.define) initialOptions.define = { global: 'globalThis' };\n\n\t\t\tinitialOptions.inject = initialOptions.inject ?? [];\n\n\t\t\tif (globals.Buffer) initialOptions.inject.push(path.resolve(__dirname, '../globals/Buffer.js'));\n\n\t\t\tif (globals.process) initialOptions.inject.push(path.resolve(__dirname, '../globals/process.js'));\n\n\t\t\tonLoad({ filter: /.*/, namespace: emptyNamespace }, () => ({\n\t\t\t\tloader: 'js',\n\t\t\t\t// Use an empty CommonJS module here instead of ESM to avoid\n\t\t\t\t// \"No matching export\" errors in esbuild for anything that\n\t\t\t\t// is imported from this file.\n\t\t\t\tcontents: 'module.exports = {}',\n\t\t\t}));\n\n\t\t\tonLoad({ filter: /.*/, namespace: errorNamespace }, (args) => ({\n\t\t\t\tloader: 'js',\n\t\t\t\tcontents: `module.exports = ${JSON.stringify(\n\t\t\t\t\t// This encoded string is detected and parsed at the end of the build to report errors\n\t\t\t\t\t`__POLYFILL_ERROR_START__::MODULE::${args.path}::IMPORTER::${args.pluginData.importer}::__POLYFILL_ERROR_END__`,\n\t\t\t\t)}`,\n\t\t\t}));\n\n\t\t\tonLoad({ filter: /.*/, namespace }, loader);\n\t\t\tonLoad({ filter: /.*/, namespace: commonjsNamespace }, loader);\n\n\t\t\t// If we are using fallbacks, we need to handle all builtin modules so that we can replace their contents,\n\t\t\t// otherwise we only need to handle the modules that are configured (which is everything by default)\n\t\t\tconst bundledModules =\n\t\t\t\tfallback === 'none'\n\t\t\t\t\t? Object.keys(modules).filter((moduleName) => builtinModules.includes(moduleName))\n\t\t\t\t\t: builtinModules;\n\n\t\t\tconst filter = new RegExp(`^(?:node:)?(?:${bundledModules.map(escapeRegex).join('|')})$`);\n\n\t\t\tconst resolver = async (args: OnResolveArgs): Promise<OnResolveResult | undefined> => {\n\t\t\t\tconst result = {\n\t\t\t\t\tempty: { namespace: emptyNamespace, path: args.path, sideEffects: false },\n\t\t\t\t\terror: {\n\t\t\t\t\t\tnamespace: errorNamespace,\n\t\t\t\t\t\tpath: args.path,\n\t\t\t\t\t\tsideEffects: false,\n\t\t\t\t\t\tpluginData: { importer: path.relative(root, args.importer).replace(/\\\\/g, '/') },\n\t\t\t\t\t},\n\t\t\t\t\tnone: undefined,\n\t\t\t\t} as const satisfies Record<string, OnResolveResult | undefined>;\n\n\t\t\t\t// https://github.com/defunctzombie/package-browser-field-spec\n\t\t\t\tif (initialOptions.platform === 'browser') {\n\t\t\t\t\tconst packageJson = await loadPackageJSON(args.resolveDir);\n\t\t\t\t\tconst browserFieldValue = packageJson?.browser as unknown as\n\t\t\t\t\t\t| Record<string, string | false>\n\t\t\t\t\t\t| string\n\t\t\t\t\t\t| undefined;\n\n\t\t\t\t\tif (typeof browserFieldValue === 'string') return;\n\t\t\t\t\tconst browserFieldValueForModule = browserFieldValue?.[args.path];\n\n\t\t\t\t\t// This is here to support consumers who have used the\n\t\t\t\t\t// \"external\" option to exclude all Node builtins (e.g.\n\t\t\t\t\t// Remix v1 does this), otherwise the import/require is left\n\t\t\t\t\t// in the output and throws an error at runtime. Ideally we\n\t\t\t\t\t// would just return undefined for any browser field value,\n\t\t\t\t\t// and we can safely switch to this in a major version.\n\t\t\t\t\tif (browserFieldValueForModule === false) return result.empty;\n\n\t\t\t\t\tif (browserFieldValueForModule !== undefined) return;\n\t\t\t\t}\n\n\t\t\t\tconst moduleName = normalizeNodeBuiltinPath(args.path);\n\n\t\t\t\tconst polyfillOption = modules[moduleName] ?? modules[`node:${moduleName}`];\n\n\t\t\t\tif (!polyfillOption) return result[fallback];\n\n\t\t\t\tif (polyfillOption === 'error' || polyfillOption === 'empty') return result[polyfillOption];\n\n\t\t\t\tconst polyfillPath = await getCachedPolyfillPath(moduleName).catch(() => null);\n\n\t\t\t\tif (!polyfillPath) return result[fallback];\n\n\t\t\t\tconst ignoreRequire = args.namespace === commonjsNamespace;\n\t\t\t\tconst isCommonjs = !ignoreRequire && args.kind === 'require-call';\n\n\t\t\t\treturn { namespace: isCommonjs ? commonjsNamespace : namespace, path: args.path, sideEffects: false };\n\t\t\t};\n\n\t\t\tonResolve({ filter }, resolver);\n\n\t\t\tonEnd(async ({ outputFiles = [] }) => {\n\t\t\t\t// This logic needs to be run when the build is complete because\n\t\t\t\t// we need to check the output files after tree-shaking has been\n\t\t\t\t// performed. If we did this in the onLoad hook, we could throw\n\t\t\t\t// errors for modules that are not even present in the final\n\t\t\t\t// output. This is particularly important when building projects\n\t\t\t\t// that target both server and browser since the browser build\n\t\t\t\t// may not use all of the modules that the server build does. If\n\t\t\t\t// you're only building for the browser, this feature is less\n\t\t\t\t// useful since any unpolyfilled modules will be treated just\n\t\t\t\t// like any other missing module.\n\n\t\t\t\tif (!shouldDetectErrorModules) return;\n\n\t\t\t\tconst errors: PartialMessage[] = [];\n\n\t\t\t\tconst { outfile, outExtension = {} } = initialOptions;\n\t\t\t\tconst jsExtension = outfile ? path.extname(outfile) : outExtension['.js'] || '.js';\n\t\t\t\tconst jsFiles = outputFiles.filter((file) => path.extname(file.path) === jsExtension);\n\n\t\t\t\tfor (const file of jsFiles) {\n\t\t\t\t\tconst matches = file.text.matchAll(\n\t\t\t\t\t\t/__POLYFILL_ERROR_START__::MODULE::(?<moduleName>.+?)::IMPORTER::(?<importer>.+?)::__POLYFILL_ERROR_END__/g,\n\t\t\t\t\t);\n\n\t\t\t\t\tfor (const { groups } of matches) {\n\t\t\t\t\t\tconst { moduleName, importer } = groups!;\n\t\t\t\t\t\tconst polyfillExists = (await getCachedPolyfillPath(moduleName).catch(() => null)) !== null;\n\t\t\t\t\t\terrors.push({\n\t\t\t\t\t\t\tpluginName: name,\n\t\t\t\t\t\t\ttext: polyfillExists\n\t\t\t\t\t\t\t\t? `Polyfill has not been configured for \"${moduleName}\", imported by \"${importer}\"`\n\t\t\t\t\t\t\t\t: `Polyfill does not exist for \"${moduleName}\", imported by \"${importer}\"`,\n\t\t\t\t\t\t\t...(formatError ? await formatError({ moduleName, importer, polyfillExists }) : {}),\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\treturn { errors };\n\t\t\t});\n\t\t},\n\t};\n};\n"]}